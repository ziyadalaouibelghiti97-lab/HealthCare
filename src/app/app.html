<div class="min-h-screen bg-gray-50 font-sans text-slate-800 pb-20">

  <!-- MAIN APP -->
  @if (currentUser) {
    <ng-container>
      <!-- HEADER -->
      <header class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-6 shadow-lg sticky top-0 z-10">
        <div class="max-w-md mx-auto">
          <div class="flex justify-between items-center mb-1">
            <h1 class="text-xl font-bold flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#f97316" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-2.246-3.646-2.5-4.5A7 7 0 0 1 12 2c.75 0 1.5.15 2.25.4.75.25 1.5.8 2.25 1.6.75.8 1.5 1.8 1.5 2.5 0 .7-.5 1.5-1.5 1.5-.5 0-1-.25-1-.75-.5-.5-1-1.25-1-2-.5-.75-1.25-1-2-1-.75 0-1.5.5-2 1.5-.5 1-.75 2.25-.75 3.5 0 1.25.25 2.5 1.25 3.5.5.5.75 1.25.75 2a5.5 5.5 0 0 1-5.5 5.5A5.5 5.5 0 0 1 2 12.5c0-1.25.5-2.25 1.5-3.25.5-.5 1-1.25 1.5-2 .5-.75 1.5-1.75 3-2.75.5 1 1 2.25 1 3.75.5.75 0 1.25-.5 1.75Z"/></svg>
              CalorieGuard
            </h1>
            <div class="flex gap-2">
              <button (click)="handleResetDay()" class="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors" title="R√©initialiser"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></button>
              <button (click)="handleLogout()" class="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors" title="Se d√©connecter"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></button>
            </div>
          </div>
          <p class="text-emerald-100 text-sm opacity-90">Bonjour, <span class="font-semibold">{{ currentDisplayName }}</span> !</p>
        </div>
      </header>

      <main class="max-w-md mx-auto px-4 mt-6">

        <!-- PROGRESS CARD -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 transform transition-all hover:scale-[1.01]">
          <div class="flex justify-between items-end mb-4">
            <div>
              <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Consomm√©</p>
              <div class="text-4xl font-extrabold" [ngClass]="{'text-red-500': isOverLimit, 'text-slate-800': !isOverLimit}">
                {{ totalCalories }} <span class="text-lg text-gray-400 font-normal">kcal</span>
              </div>
            </div>
            <div class="text-right">
              <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Restant</p>
              <div class="text-2xl font-bold" [ngClass]="remainingCalories < 0 ? 'text-red-500' : 'text-emerald-600'">
                {{ remainingCalories }}
              </div>
            </div>
          </div>

          <!-- Bar -->
          <div class="relative h-4 bg-gray-100 rounded-full overflow-hidden mb-3 shadow-inner">
            <div class="absolute top-0 left-0 h-full transition-all duration-700 ease-out"
                 [ngClass]="{'bg-red-500': isOverLimit, 'bg-orange-400': !isOverLimit && progressPercentage > 85, 'bg-emerald-500': !isOverLimit && progressPercentage <= 85}"
                 [style.width.%]="progressPercentage">
            </div>
          </div>

          <!-- Controls -->
          <div class="flex justify-between items-center text-xs font-medium">
            <button (click)="toggleGoalInput()" class="flex items-center gap-1 text-gray-500 hover:text-emerald-600 transition-colors bg-gray-50 px-2 py-1 rounded-md" title="Modifier l'objectif">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
              Objectif: {{ dailyGoal }}
            </button>
            <div class="flex gap-2">
              <button (click)="getCoachTip()" [disabled]="isCoachLoading" class="flex items-center gap-1 bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-3 py-1 rounded-full hover:shadow-md transition-all disabled:opacity-70">
                <span *ngIf="!isCoachLoading">‚ú® Coach</span><span *ngIf="isCoachLoading">...</span>
              </button>
              @if (isOverLimit) { <span class="flex items-center gap-1 text-red-500 animate-pulse font-bold">!</span> }
            </div>
          </div>

          @if (coachTip) {
            <div class="mt-4 p-3 bg-indigo-50 border border-indigo-100 rounded-lg text-sm text-indigo-800 animate-fadeIn flex justify-between gap-2">
              <div class="flex gap-2"><span class="text-xl">ü§ñ</span><p>{{ coachTip }}</p></div>
              <button (click)="coachTip = ''" class="text-indigo-400 hover:text-indigo-600 self-start">x</button>
            </div>
          }

          @if (showGoalInput) {
            <div class="mt-4 pt-4 border-t border-gray-100 animate-fadeIn">
              <label class="block text-sm text-gray-600 mb-1 font-medium">Modifier l'objectif quotidien (kcal)</label>
              <div class="flex gap-2">
                <input type="number" [(ngModel)]="dailyGoal" name="dailyGoal" (ngModelChange)="saveData()" (keyup.enter)="showGoalInput = false" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                <button (click)="showGoalInput = false" class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200">OK</button>
              </div>
            </div>
          }
        </div>

        <!-- TABS & FORMS -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6 relative">

          <!-- Tabs Header -->
          <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
            <div class="flex gap-4">
              <button (click)="mode = 'simple'" [class]="mode === 'simple' ? 'text-emerald-600 border-b-2 border-emerald-500 font-bold' : 'text-gray-400 hover:text-gray-600'" class="pb-2 text-sm flex items-center gap-1 transition-all">
                Repas Rapide
              </button>
              <button (click)="mode = 'recipe'" [class]="mode === 'recipe' ? 'text-purple-600 border-b-2 border-purple-500 font-bold' : 'text-gray-400 hover:text-gray-600'" class="pb-2 text-sm flex items-center gap-1 transition-all">
                Cr√©er Recette
              </button>
            </div>
          </div>

          <!-- MODE 1: SIMPLE -->
          @if (mode === 'simple') {
            <div class="animate-fadeIn">
              <button (click)="toggleSuggestions()" class="w-full text-left text-xs mb-3 flex items-center justify-between text-gray-500 bg-gray-50 p-2 rounded-lg hover:bg-gray-100">
                <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-2.25-1.75-4-4-4-2.25 0-4 1.75-4 4 0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg> Suggestions & Mes Plats</span>
                @if (!showSuggestions) { <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg> }
                @if (showSuggestions) { <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg> }
              </button>

              @if (showSuggestions) {
                <div class="mb-4 animate-fadeIn">
                  <div class="flex gap-2 mb-2">
                    <button (click)="suggestionFilter = 'all'" [class.font-bold]="suggestionFilter === 'all'" class="text-xs text-orange-500">Tous</button>
                    <button (click)="suggestionFilter = 'custom'" [class.font-bold]="suggestionFilter === 'custom'" class="text-xs text-purple-500">Mes Plats</button>
                  </div>
                  <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar">
                    @if (suggestionFilter === 'all') {
                      @for (food of foodDatabase; track food.name) {
                        <button (click)="handleSelectSuggestion(food)" class="text-xs bg-orange-50 border border-orange-100 text-orange-700 px-3 py-1 rounded-full hover:bg-orange-100">{{ food.name }} ({{ food.calories }} kcal/{{food.standardAmount}}{{food.unit}})</button>
                      }
                    }
                    @if (suggestionFilter === 'custom') {
                      @for (food of customFoods; track food.name) {
                        <div class="inline-flex items-center text-xs bg-purple-50 border border-purple-100 rounded-full mr-2 mb-2">
                          <button (click)="handleSelectSuggestion(food)" class="px-3 py-1 text-purple-700 hover:bg-purple-100 rounded-l-full">{{ food.name }}</button>
                          <button (click)="deleteCustomFood(food, $event)" class="px-2 py-1 text-purple-300 hover:text-red-500 rounded-r-full">√ó</button>
                        </div>
                      }
                      @if (customFoods.length === 0) {
                        <div class="text-xs text-gray-400 italic">Aucun plat enregistr√©.</div>
                      }
                    }
                  </div>
                </div>
              }

              <form (ngSubmit)="handleAddFood()" class="flex flex-col gap-3">
                <div class="relative flex gap-2">
                  <div class="relative w-full">
                    <input list="food-suggestions-list" type="text" placeholder="Nom (ex: Pain, Riz...)" [(ngModel)]="foodName" name="foodName" (input)="handleNameChange($event)" class="w-full pl-3 pr-10 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all"/>
                    @if (foodName) {
                      <button type="button" (click)="resetForm()" class="absolute right-12 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                    }
                    <button type="button" (click)="estimateCalories()" [disabled]="!foodName || isAnalyzing" class="absolute right-2 top-2 bottom-2 aspect-square flex items-center justify-center bg-purple-100 text-purple-600 hover:bg-purple-200 rounded-lg transition-colors disabled:opacity-50">
                      @if (!isAnalyzing) { <span>‚ú®</span> }
                      @if (isAnalyzing) { <svg class="animate-spin h-5 w-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> }
                    </button>
                  </div>
                  <datalist id="food-suggestions-list">
                    @for (food of allFoods; track food.name) {
                      <option [value]="food.name"></option>
                    }
                  </datalist>
                </div>
                @if (analysisError) { <div class="text-xs text-red-500 ml-1 -mt-2">{{ analysisError }}</div> }

                <!-- LIGNE QUANTIT√â ET CALORIES -->
                <div class="flex gap-2">
                  <!-- QUANTIT√â -->
                  <div class="relative w-1/3">
                    <input type="number" [(ngModel)]="inputQuantity" name="quantity" (ngModelChange)="recalcCalories()" placeholder="Qt√©" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all text-center"/>
                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400 font-medium pointer-events-none">{{ currentUnit }}</span>
                  </div>

                  <!-- CALORIES -->
                  <div class="relative w-1/3">
                    <input type="number" [(ngModel)]="calories" name="calories" placeholder="Kcal" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all text-center"/>
                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400 font-medium pointer-events-none">kcal</span>
                  </div>

                  <!-- BOUTONS -->
                  <div class="flex gap-1 w-1/3">
                    <button type="button" (click)="saveCustomFood()" [disabled]="!foodName || !calories" class="flex-1 bg-purple-100 text-purple-600 hover:bg-purple-200 disabled:opacity-50 disabled:cursor-not-allowed rounded-xl transition-colors flex items-center justify-center">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                    </button>
                    <button type="submit" [disabled]="!foodName || !calories" class="flex-1 bg-emerald-500 hover:bg-emerald-600 disabled:bg-gray-300 text-white rounded-xl transition-colors flex items-center justify-center">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          }

          <!-- MODE 2: RECIPE (RESTAUR√â) -->
          @if (mode === 'recipe') {
            <div class="animate-fadeIn">
              <div class="mb-4">
                <input type="text" [(ngModel)]="recipeName" placeholder="Nom de la recette (ex: Salade Compos√©e)" class="w-full p-2 border-b border-purple-200 focus:outline-none focus:border-purple-500 font-medium text-purple-900 placeholder-purple-300 bg-transparent"/>
              </div>

              <!-- Ingredients Input -->
              <div class="bg-purple-50 rounded-lg p-3 mb-4">
                <p class="text-xs font-bold text-purple-500 mb-2 uppercase">Ajouter un ingr√©dient</p>
                <div class="flex gap-2 mb-2">
                  <div class="relative w-full">
                    <input type="text" list="ingredient-list" [(ngModel)]="ingredientName" (input)="handleIngredientChange($event)" placeholder="Ingr√©dient (ex: Tomate)" class="w-full p-2 text-sm rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-400 focus:outline-none"/>
                    <datalist id="ingredient-list">
                      @for (food of foodDatabase; track food.name) { <option [value]="food.name"></option> }
                    </datalist>
                  </div>
                  <input type="number" [(ngModel)]="ingredientCalories" placeholder="Kcal" class="w-20 p-2 text-sm rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-400 focus:outline-none"/>
                  <button (click)="addIngredient()" [disabled]="!ingredientName || !ingredientCalories" class="bg-purple-500 text-white rounded-lg px-3 hover:bg-purple-600 disabled:opacity-50">+</button>
                </div>
              </div>

              <!-- List -->
              <div class="mb-4">
                @if (recipeIngredients.length === 0) { <p class="text-xs text-gray-400 mb-1">Aucun ingr√©dient ajout√©.</p> }
                @for (ing of recipeIngredients; track ing.name; let i = $index) {
                  <div class="flex justify-between items-center text-sm border-b border-gray-50 py-2">
                    <span>{{ ing.name }}</span>
                    <div class="flex items-center gap-3">
                      <span class="text-gray-500 font-medium">{{ ing.calories }} kcal</span>
                      <button (click)="removeIngredient(i)" class="text-red-300 hover:text-red-500">√ó</button>
                    </div>
                  </div>
                }
              </div>

              <!-- Footer -->
              <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                <div>
                  <p class="text-xs text-gray-500">Total Recette</p>
                  <p class="text-xl font-bold text-purple-700">{{ recipeTotalCalories }} <span class="text-sm font-normal">kcal</span></p>
                </div>
                <button (click)="saveRecipe()" [disabled]="recipeIngredients.length === 0 || !recipeName" class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-300 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-md transition-colors">
                  Enregistrer Plat
                </button>
              </div>
            </div>
          }

        </div>

        <!-- JOURNAL -->
        <div class="space-y-3 pb-8">
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider ml-1">Journal de {{ currentDisplayName }}</h3>
          @if (items.length === 0) {
            <div class="text-center py-10 opacity-50 bg-white rounded-xl border border-dashed border-gray-300">
              <div class="inline-block p-4 bg-gray-50 rounded-full mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
              </div>
              <p class="text-sm">Rien pour l'instant.</p>
            </div>
          }

          @for (item of items; track item.id) {
            <div class="group bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition-shadow">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 font-bold text-sm shadow-sm">{{ item.name.charAt(0).toUpperCase() }}</div>
                <div>
                  <p class="font-medium text-gray-800">{{ item.name }}</p>
                  <!-- Affichage de la quantit√© si dispo -->
                  <p class="text-xs text-gray-400">
                    @if (item.quantity) { {{ item.quantity }}{{ item.unit }} ‚Ä¢ } {{ item.time }}
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <span class="font-bold text-gray-700 bg-gray-100 px-2 py-1 rounded-md text-sm">{{ item.calories }} kcal</span>
                <button (click)="handleDeleteItem(item.id)" class="text-gray-300 hover:text-red-500 transition-colors p-2 hover:bg-red-50 rounded-full">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                </button>
              </div>
            </div>
          }
        </div>
      </main>
    </ng-container>
  }
</div>
